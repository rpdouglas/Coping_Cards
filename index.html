<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- UPDATED: Title for the application -->
  <title>The Addicts Agenda</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #f7f7f9;
      --card-radius: 16px;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --color-blue: #2b77f0;
      --color-shadow: rgba(43, 119, 240, 0.3);
      /* Define a neutral gray for secondary text/borders, now darker for contrast */
      --color-gray: #444; 
      --color-light-gray: #f0f0f0;
    }
    /* FIX: Remove height:100% from html,body and allow the body to scroll */
    html,body{margin:0;font-family:var(--font-family);background:linear-gradient(180deg,#f4f7fb,#ffffff);display:flex;align-items:center;justify-content:center; min-height: 100vh;}
    .app{width:100%;max-width:720px;padding:24px;box-sizing:border-box}
    .hero{background:#ffffff;padding:28px;border-radius:18px;box-shadow:0 6px 18px rgba(32,40,60,0.08);text-align:center; position: relative; /* Added for cog positioning */ }
    h1{margin:0;font-size:28px}
    p.sub{color:#556;opacity:0.8;margin-top:8px}

    /* NEW: Version Number Positioning */
    #appVersion {
        position: absolute;
        top: 15px;
        left: 15px;
        font-size: 14px;
        color: #888;
        font-weight: 500;
    }

    /* NEW: Settings Cog Positioning */
    .settings-container {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    button.settings-cog {
        font-size: 24px;
        color: var(--color-gray); /* Dark gray color */
        padding: 5px;
        transition: transform 0.3s;
        background: none;
        border: none;
        cursor: pointer;
    }
    button.settings-cog:hover {
        transform: rotate(30deg);
    }
    .settings-group h3 {
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #333;
        text-align: left;
    }

    /* Primary Blue Button Style (Used for Cards, Journal, and To Do List) */
    button.primary{margin-top:20px;padding:14px 20px;border-radius:12px;border:0;background:var(--color-blue);color:#fff;font-size:18px;font-weight:600;width:100%;box-shadow:0 6px 16px var(--color-shadow);cursor:pointer;transition:background 0.2s; text-align: center;} /* Default centered text */
    button.primary:hover{background:#2361c4}
    
    /* WORKBOOKS PAGE BUTTON FIX: Align text left only for workbook buttons */
    #workbooksView button.primary {
        text-align: left;
        padding-left: 20px;
    }
    
    /* NEW: Reflection Button Group Styling */
    .reflection-group {
        display: flex;
        gap: 15px; /* Spacing between the two reflection buttons */
        margin-top: 15px;
    }
    .reflection-group button.primary {
        margin-top: 0;
        width: 50%; /* Make them share the width */
        padding-left: 10px;
        padding-right: 10px;
    }


    /* Secondary/Action Buttons (Default) */
    button{cursor:pointer;background:none;border:none;color:var(--color-blue);font-size:16px;padding:8px;font-weight:500}
    
    /* UPDATED: Secondary style for next/home buttons with high contrast */
    button.secondary {
        /* Set background to white */
        background: #ffffff; 
        /* Set text color to a dark gray for high contrast */
        color: var(--color-gray); 
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
        /* Give it a subtle shadow to lift it off the card background */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        border: 1px solid #d0d0d0;
    }
    button.secondary:hover {
        background: #f5f5f5;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    /* ADDED FOR ACCESSIBILITY */
    button:focus-visible {
      outline: 2px solid var(--color-blue);
      outline-offset: 2px;
    }
    input[type="date"], input[type="text"], select {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: var(--font-family);
        font-size: 16px;
        box-sizing: border-box;
    }
    select {
        width: 100%;
        cursor: pointer;
    }

    /* Fact Box Styling */
    .fact-box {
        margin-top: 30px;
        padding: 20px;
        background: #f0f7ff;
        border: 1px solid #d0e4ff;
        border-radius: 12px;
        text-align: center;
    }
    .fact-box h2 {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-blue);
        margin-top: 0;
        margin-bottom: 10px;
    }
    .fact-box p {
        font-size: 16px;
        color: #444;
        margin: 0;
        font-style: italic;
    }
    
    /* Sobriety Duration on Home Screen */
    #homeSobrietyDuration {
        margin: 15px 0 0 0;
        font-size: 1.1em;
        font-weight: 600;
        color: #555;
    }

    /* Card View Styles */
    .card-area{
        min-height: 400px;
        height: 400px; /* Fixed Height for Playing Card Aesthetic */
        width: 300px;  /* Fixed Width for Playing Card Aesthetic */
        max-width: 90vw; /* Responsive limit */
        background: #ffffff; /* White card face */
        border: 4px solid var(--color-gray);
        border-radius: var(--card-radius);
        padding: 10px; /* Internal padding */
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        text-align: center; 
        position: relative; /* For absolutely positioned elements */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        margin: 20px auto;
    }
    
    /* Container for the background color/gradient */
    #cardBackground {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 12px;
        opacity: 0.1; /* Subtler color overlay */
    }

    /* NEW: Top Left Corner with Icon and Suit Text */
    #cardCorner {
        position: absolute;
        top: 15px;
        left: 15px;
        text-align: center;
        font-weight: 700;
        color: var(--color-gray); /* Text color set to dark gray */
    }
    #cardCorner #cornerIcon {
        font-size: 30px; /* Smaller icon for the corner */
        line-height: 1;
        margin-bottom: 2px;
    }
    #cardCorner #cornerSuit {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Main Card Text */
    #cardTextContainer {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        height: 100%;
        padding: 50px 20px 20px 20px; /* Padding to clear corner elements */
    }
    #cardText {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        color: #333; /* Dark text for readability on white card */
    }
    
    /* Elements removed from original style, ensuring they don't interfere */
    #cardIcon{display: none;}
    #cardSuit{display: none;}
    
    .actions button{margin:0 10px}
    .status-text{font-size:14px;color:#777;margin-top:10px}

    /* Shared Content Styles */
    .content-card {
        background: #ffffff;
        padding: 24px;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(32,40,60,0.08);
        /* FIX: Allow content cards to grow vertically without height constraints */
        width: 100%;
        box-sizing: border-box;
    }
    .content-card h2 {
        font-size: 24px;
        margin-top: 0;
        color: #333;
        text-align: center;
    }
    textarea {
        width: 100%;
        height: 300px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: var(--font-family);
        font-size: 16px;
        resize: vertical;
        box-sizing: border-box;
        margin-top: 15px;
    }
    .actions-row {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .list-view-actions {
        display: flex;
        gap: 10px;
    }
    .list-view-actions button {
        margin: 0;
    }
    .prompt-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    /* To Do List Specific Styles */
    .todo-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px; /* Reduced margin */
        flex-wrap: wrap;
    }
    .todo-input-group input[type="text"] {
        flex-grow: 1;
        min-width: 150px;
    }
    /* NEW: Styling for recurrence and date inputs in the task form */
    .todo-input-group input[type="date"], .todo-input-group select {
        width: auto;
        flex-grow: 0;
        min-width: 100px;
    }
    .todo-list {
        list-style: none;
        padding: 0;
        margin-top: 0;
    }
    .todo-list li {
        display: flex;
        flex-direction: column; /* Stack details vertically */
        align-items: flex-start;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .todo-list li:last-child {
        border-bottom: none;
    }
    .todo-main-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .todo-text {
        flex-grow: 1;
        cursor: pointer;
        padding: 0 5px;
        font-weight: 500;
    }
    .todo-details {
        font-size: 0.9em;
        color: #777;
        margin-top: 5px;
    }
    .todo-completed {
        text-decoration: line-through;
        color: #888;
    }
    /* Prompt Manager Styles */
    .prompt-list-manager li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    /* Workbook Styles */
    .workbook-question {
        margin-bottom: 30px;
        border-left: 3px solid var(--color-blue);
        padding-left: 15px;
    }
    .workbook-question h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
    }
    .workbook-question textarea {
        height: 150px;
        margin-top: 0;
    }
    
    /* NEW: Collapsible styles for Workbook */
    .workbook-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        margin: 20px -24px 0 -24px; /* Extend full width of content-card */
        background-color: var(--color-light-gray);
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        font-size: 1.2em;
        font-weight: 700;
        color: #333;
        cursor: pointer;
    }
    .workbook-section-header:hover {
        background-color: #e5e5e5;
    }
    .workbook-section-header h3 {
        margin: 0;
        font-size: 1em; /* Use 1em since parent is 1.2em */
    }
    .collapse-icon {
        font-size: 1.5em;
        transition: transform 0.3s;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    .section-content {
        max-height: 2000px; /* large enough for content */
        overflow: hidden;
        transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
    }
    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
    }

    /* Literature Styles */
    .literature-chapter {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    .literature-chapter h3 {
        color: var(--color-blue);
        border-bottom: 2px solid var(--color-blue);
        padding-bottom: 5px;
        margin-top: 0;
        font-size: 1.4em;
    }
    .literature-chapter p {
        text-align: justify;
        line-height: 1.6;
        color: #555;
        margin-top: 15px;
    }
    .literature-link {
        display: block;
        margin-top: 30px;
        text-align: center;
        font-style: italic;
    }

    /* Daily Reflection Styles */
    #reflectionContent {
        min-height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 15px;
        background: #f7f7f9;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-top: 15px;
    }

    #reflectionDateInput {
        max-width: 200px;
        margin: 15px auto 5px auto;
        display: block;
    }

    #reflectionQuote {
        font-size: 1.2em;
        font-style: italic;
        color: #333;
        margin-bottom: 15px;
    }
    #reflectionReading {
        color: #555;
        line-height: 1.6;
    }
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--color-blue);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" style="display:block;">
        <div class="hero">
            <!-- NEW: App Version Number -->
            <div id="appVersion">V0.6</div>

            <!-- NEW: Settings Cog -->
            <div class="settings-container">
                <button id="goToSettingsBtn" class="settings-cog" title="Settings">&#x2699;</button>
            </div>
            
            <h1>The Addicts Agenda</h1>
            <p class="sub">Find inspiration and practical tools for your recovery journey.</p>
            
            <!-- NEW: Sobriety Duration Display -->
            <p id="homeSobrietyDuration" style="color: var(--color-blue);">Set your sober date in Settings.</p>
            
            <div class="fact-box">
                <h2 id="dailyFactHeader">Recovery Fact of the Day</h2>
                <p id="dailyFactText">Loading daily inspiration...</p>
            </div>

            <!-- Button 1: Draw Coping Cards (Text Changed) -->
            <button id="goToCardsBtn" class="primary">Draw a Coping Card</button>

            <!-- Button 2: Start Journaling (Style Changed to Primary) -->
            <button id="goToJournalBtn" class="primary" style="margin-top: 15px;">Start Journaling</button>
            
            <!-- Button 3: To Do List (NEW) -->
            <button id="goToTodoBtn" class="primary" style="margin-top: 15px;">View To Do List</button>
            
            <!-- NEW Button Group for Reflections -->
            <div class="reflection-group">
                <!-- Button 4: Daily Reflection -->
                <button id="goToReflectionBtn" class="primary">Daily Reflection (AA)</button>
                <!-- NEW Button 5: Just For Today -->
                <button id="goToJFTBtn" class="primary">Just for Today (NA)</button>
            </div>


            <!-- NEW Button 6: Recovery Literature -->
            <button id="goToLiteratureBtn" class="primary" style="margin-top: 15px;">Recovery Literature</button>

            <!-- NEW Button 7: Recovery Workbooks -->
            <button id="goToWorkbooksBtn" class="primary" style="margin-top: 15px;">Recovery Workbooks</button>
        </div>
    </div>
    
    <!-- 2. CARD INTRO SCREEN (Unused) -->
    <div id="cardIntro" style="display:none;">
      <div class="hero">
        <h1>52 Coping Cards</h1>
        <p class="sub">Need a quick strategy to manage a craving? Draw a card.</p>
        <button id="drawBtn" class="primary">Draw a Card</button>
      </div>
    </div>
    
    <!-- 3. CARD VIEW SCREEN -->
    <div id="cardView" style="display:none;">
      <div id="cardArea" class="card-area">
        <!-- NEW: Subtle color background layer (for gradient effect) -->
        <div id="cardBackground"></div>
        
        <!-- NEW: Top Left Corner with Icon and Suit Name -->
        <div id="cardCorner">
            <span id="cornerIcon" class="card-icon"></span>
            <div id="cornerSuit" class="card-suit"></div>
        </div>

        <!-- Main Card Content (Centered Text) -->
        <div id="cardTextContainer">
            <p id="cardText">Coping Card Text</p>
        </div>

        <div class="actions">
          <button id="nextBtn" class="secondary">Next Card</button>
          <button id="resetBtn" class="secondary">Home</button>
        </div>
        <div id="statusText" class="status-text"></div>
      </div>
    </div>

    <!-- 4. JOURNAL VIEW SCREEN -->
    <div id="journalView" style="display:none;">
        <div class="content-card">
            
            <!-- Journal List View (initially hidden) -->
            <div id="journalList" style="display:none;">
                <h2>Journal Entries</h2>
                <div class="list-view-actions">
                    <button id="openListHomeBtn" class="secondary">Home</button>
                    <button id="newEntryBtn" class="secondary">Write Today's Entry</button>
                </div>
                <ul id="entryList" class="journal-entry-list">
                    <li>No entries saved yet.</li>
                </ul>
            </div>

            <!-- Journal Prompt Manager (NEW, initially hidden) -->
            <div id="promptManagerView" style="display:none;">
                <h2>Manage Custom Prompts</h2>
                <div class="prompt-row">
                    <input type="text" id="customPromptInput" placeholder="Enter new prompt text (e.g., What did I learn today?)" style="flex-grow: 1;">
                    <button id="addCustomPromptBtn" class="secondary">Add</button>
                </div>
                <p class="sub" style="text-align: center;">Click a prompt below to delete it.</p>
                <ul id="customPromptList" class="journal-entry-list prompt-list-manager">
                    <!-- Custom Prompts will be rendered here -->
                </ul>
                <div class="actions-row" style="justify-content: flex-end; margin-top: 20px;">
                    <button id="backToEntryBtn" class="secondary">Back to Journal</button>
                </div>
            </div>

            <!-- Journal Entry View (today's entry) -->
            <div id="journalEntryView">
                <h2>Today's Reflection</h2>
                <p class="sub" style="text-align: center;">Use this space to process cravings, track progress, or reflect on your card.</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="entryDate">Date:</label>
                    <input type="date" id="entryDate">
                </div>
                
                <div class="prompt-row" style="margin-top: 15px;">
                    <select id="promptSelect">
                        <!-- Prompts loaded here -->
                    </select>
                    <button id="managePromptsBtn" class="secondary">Manage Prompts</button>
                </div>

                <textarea id="journalEntry" placeholder="What's on your mind today?"></textarea>
                
                <div class="actions-row">
                    <button id="viewAllEntriesBtn" class="secondary">View All Entries</button>
                    <div class="list-view-actions">
                        <button id="saveJournalBtn" class="secondary">Save Entry</button>
                        <button id="entryHomeBtn" class="secondary">Home</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. SETTINGS VIEW SCREEN -->
    <div id="settingsView" style="display:none;">
        <div class="content-card">
            <h2>App Settings</h2>
            <div class="settings-group">
                <p class="sub" style="text-align: center; margin-bottom: 20px;">Track your journey.</p>
                <h3>Sober Date Tracking</h3>
                <label for="soberDateInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Your Sober Date:</label>
                <input type="date" id="soberDateInput" style="width: 100%; margin-bottom: 20px;">
                <p id="sobrietyDuration" style="font-size: 1.1em; font-weight: bold; text-align: center; color: var(--color-blue); min-height: 20px;"></p>
            </div>
            <div class="actions-row" style="justify-content: flex-end; gap: 10px;">
                <button id="saveSettingsBtn" class="secondary">Save Date</button>
                <button id="settingsHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 6. NEW TO DO LIST VIEW SCREEN -->
    <div id="todoView" style="display:none;">
        <div class="content-card">
            <h2>My To Do List</h2>
            <p class="sub" style="text-align: center;">Keep track of small, actionable tasks.</p>
            
            <!-- NEW: Task Input Form with Date and Recurrence -->
            <div class="todo-input-group">
                <input type="text" id="todoInput" placeholder="Task description">
                <input type="date" id="todoDateInput">
                <select id="todoRecurrenceSelect">
                    <option value="none">No Repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Every 2 Weeks</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button id="addTodoBtn" class="secondary">Add Task</button>
            </div>
            
            <ul id="todoList" class="todo-list">
                <!-- To Do Items will be rendered here -->
            </ul>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px;">
                <button id="todoHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>

    <!-- 7. NEW RECOVERY LITERATURE VIEW SCREEN -->
    <div id="literatureView" style="display:none;">
        <div class="content-card">
            <h2>Recovery Literature: Big Book Excerpts</h2>
            <p class="sub" style="text-align: center;">Read key foundational texts from the fellowship.</p>
            
            <div id="literatureContent">
                <!-- Chapter 1: Bill's Story -->
                <div class="literature-chapter">
                    <h3>Chapter 1: Bill's Story</h3>
                    <p>Bill W.'s story is the compelling and historic account of how the co-founder of Alcoholics Anonymous discovered his powerlessness over alcohol and, through a spiritual experience and connection with others, found a way out. It details his struggles in the business world, his devastating descent into alcoholism, his institutionalization, and the transformative visit from his old friend, Ebby T. His realization that only a spiritual experience and helping others could provide lasting sobriety became the bedrock of the entire program.</p>
                </div>

                <!-- Chapter 2: There is a Solution -->
                <div class="literature-chapter">
                    <h3>Chapter 2: There is a Solution</h3>
                    <p>This chapter provides hope by asserting that recovery from alcoholism is possible. It emphasizes the importance of the fellowship (the "hundreds of men and women" who have recovered) and the fact that the solution lies not just in stopping drinking, but in a spiritual program of action. It introduces the core concept that alcoholism is a threefold disease—physical, mental, and spiritual—and that the spiritual malady requires a spiritual remedy, a practical method for living soberly.</p>
                </div>
            </div>

            <p class="literature-link">
                For the complete text, download the 
                <a href="https://aa-netherlands.org/for-members/big-book-online/" target="_blank" style="color: var(--color-blue); font-weight: 600;">Big Book Online (PDF)</a>.
            </p>

            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="literatureHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>

    <!-- 8. NEW RECOVERY WORKBOOKS VIEW SCREEN -->
    <div id="workbooksView" style="display:none;">
        <div class="content-card">
            <h2>Recovery Workbooks</h2>
            <p class="sub" style="text-align: center;">Tools and step work resources.</p>
            <!-- NEW: Button to Step 1 Workbook -->
            <button id="goToStep1Btn" class="primary" style="margin-top: 15px;">Step 1: Powerlessness & Unmanageability</button>
            <!-- NEW: Button to Step 2 Workbook -->
            <button id="goToStep2Btn" class="primary" style="margin-top: 15px;">Step 2: Coming to Believe</button>
            <!-- NEW: Button to Step 3 Workbook -->
            <button id="goToStep3Btn" class="primary" style="margin-top: 15px;">Step 3: Turning It Over</button>
            <!-- NEW: Button to Step 4 Workbook -->
            <button id="goToStep4Btn" class="primary" style="margin-top: 15px;">Step 4: Moral Inventory</button>
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="workbooksHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 9. NEW STEP ONE WORKBOOK VIEW SCREEN -->
    <div id="stepOneView" style="display:none;">
        <div class="content-card">
            <h2>Step 1: Admitted Powerlessness</h2>
            <p class="sub" style="text-align: center;">"We admitted we were powerless over cocaine and all other mind-altering substances—that our lives had become unmanageable."</p>
            
            <div id="stepOneQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepOneSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepOneBtn" class="secondary">Save Progress</button>
                    <button id="stepOneWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. NEW STEP TWO WORKBOOK VIEW SCREEN -->
    <div id="stepTwoView" style="display:none;">
        <div class="content-card">
            <h2>Step 2: Coming to Believe</h2>
            <p class="sub" style="text-align: center;">"We came to believe that a Power greater than ourselves could restore us to sanity."</p>
            
            <div id="stepTwoQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepTwoSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepTwoBtn" class="secondary">Save Progress</button>
                    <button id="stepTwoWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 11. NEW STEP THREE WORKBOOK VIEW SCREEN -->
    <div id="stepThreeView" style="display:none;">
        <div class="content-card">
            <h2>Step 3: Turning It Over</h2>
            <p class="sub" style="text-align: center;">"We made a decision to turn our will and our lives over to the care of God as we understood Him."</p>
            
            <div id="stepThreeQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepThreeSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepThreeBtn" class="secondary">Save Progress</button>
                    <button id="stepThreeWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 12. NEW STEP FOUR WORKBOOK VIEW SCREEN -->
    <div id="stepFourView" style="display:none;">
        <div class="content-card">
            <h2>Step 4: Moral Inventory</h2>
            <p class="sub" style="text-align: center;">"Made a searching and fearless moral inventory of ourselves."</p>
            
            <div id="stepFourQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepFourSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepFourBtn" class="secondary">Save Progress</button>
                    <button id="stepFourWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 13. NEW DAILY REFLECTION VIEW SCREEN -->
    <div id="reflectionView" style="display:none;">
        <div class="content-card">
            <h2>Daily Reflection (AA)</h2>
            <p class="sub" style="text-align: center;">A daily quote and meditation to guide your thoughts.</p>
            
            <label for="reflectionDateInput" style="display: block; text-align: center; font-weight: 600; margin-top: 10px;">Select Date:</label>
            <input type="date" id="reflectionDateInput">

            <div id="reflectionContent">
                <div class="loading-spinner" id="reflectionSpinner"></div>
                <p id="reflectionQuote" style="display: none;">Quote goes here.</p>
                <p id="reflectionReading" style="display: none;">Reading goes here.</p>
            </div>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="reflectionHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 14. NEW JUST FOR TODAY VIEW SCREEN -->
    <div id="jftView" style="display:none;">
        <div class="content-card">
            <h2>Just for Today (NA)</h2>
            <p class="sub" style="text-align: center;">The daily spiritual message from Narcotics Anonymous.</p>
            
            <label for="jftDateInput" style="display: block; text-align: center; font-weight: 600; margin-top: 10px;">Select Date:</label>
            <input type="date" id="jftDateInput">

            <div id="jftContent" style="min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 15px; background: #f7f7f9; border-radius: 10px; border: 1px solid #ddd; margin-top: 15px;">
                <div class="loading-spinner" id="jftSpinner"></div>
                <p id="jftQuote" style="display: none; font-size: 1.2em; font-style: italic; color: #333; margin-bottom: 15px;">Quote goes here.</p>
                <p id="jftReading" style="display: none; color: #555; line-height: 1.6;">Reading goes here.</p>
            </div>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="jftHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>


  </div>
  
  <script type="module">
    // --- START: MODULAR JAVASCRIPT ---
    
    // Import all necessary data and module helpers
    import { JournalEventHandlers, showJournalEntryView, showJournalListView, showPromptManagerView } from './journal.js'; 
    import { LiteratureLogic } from './literature.js'; 
    import { WorkbookLogic } from './workbooks.js'; 
    import { App } from './global_events.js'; 
    

    // Bind the journal handlers that were separated into the journal module
    const bindJournalHandlers = () => {
        document.getElementById('entryHomeBtn').addEventListener('click', () => App.ViewManager.displayAppView('homeScreen'));
        document.getElementById('openListHomeBtn').addEventListener('click', () => App.ViewManager.displayAppView('homeScreen'));
        document.getElementById('managePromptsBtn').addEventListener('click', showPromptManagerView);
        document.getElementById('backToEntryBtn').addEventListener('click', () => showJournalEntryView(JournalEventHandlers.getCurrentJournalKey()));
        
        document.getElementById('addCustomPromptBtn').addEventListener('click', JournalEventHandlers.handlePromptAdd);
        document.getElementById('promptSelect').addEventListener('change', JournalEventHandlers.handlePromptSelect);
        document.getElementById('saveJournalBtn').addEventListener('click', JournalEventHandlers.handleSave);
        document.getElementById('entryDate').addEventListener('change', JournalEventHandlers.handleDateChange);
        document.getElementById('viewAllEntriesBtn').addEventListener('click', showJournalListView);
        document.getElementById('newEntryBtn').addEventListener('click', () => showJournalEntryView());
    }

    const bindWorkbookHandlers = () => {
        // --- Workbooks Nav ---
        document.getElementById('goToStep1Btn').addEventListener('click', WorkbookLogic.showStepOneView);
        document.getElementById('goToStep2Btn').addEventListener('click', WorkbookLogic.showStepTwoView);
        document.getElementById('goToStep3Btn').addEventListener('click', WorkbookLogic.showStepThreeView);
        document.getElementById('goToStep4Btn').addEventListener('click', WorkbookLogic.showStepFourView);
        document.getElementById('stepOneWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome);
        document.getElementById('stepTwoWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome);
        document.getElementById('stepThreeWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome);
        document.getElementById('stepFourWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome);
        
        // Workbook Save Bindings: Must be explicitly bound
        document.getElementById('saveStepOneBtn').addEventListener('click', () => WorkbookLogic.collectAndSaveWorkbookAnswers('stepOneQuestions', 'saveStepOneBtn', 'stepOneSaveStatus'));
        document.getElementById('saveStepTwoBtn').addEventListener('click', () => WorkbookLogic.collectAndSaveWorkbookAnswers('stepTwoQuestions', 'saveStepTwoBtn', 'stepTwoSaveStatus'));
        document.getElementById('saveStepThreeBtn').addEventListener('click', () => WorkbookLogic.collectAndSaveWorkbookAnswers('stepThreeQuestions', 'saveStepThreeBtn', 'stepThreeSaveStatus'));
        document.getElementById('saveStepFourBtn').addEventListener('click', () => WorkbookLogic.collectAndSaveWorkbookAnswers('stepFourQuestions', 'saveStepFourBtn', 'stepFourSaveStatus'));
    }
    
    const bindReflectionHandlers = () => {
        // --- Daily Reflection Listener ---
        document.getElementById('reflectionDateInput').addEventListener('change', (e) => {
            App.ReflectionLogic.getDailyReflection(e.target.value);
        });
        
        // --- Just For Today Listener ---
        document.getElementById('jftDateInput').addEventListener('change', (e) => {
            App.ReflectionLogic.getJustForToday(e.target.value);
        });
    }


    // Override the base App.bindEventListeners to include all module bindings
    const originalBindEventListeners = App.bindEventListeners;

    App.bindEventListeners = () => {
        // Call the original bindings from global_events.js (general buttons, settings, todo, card nav)
        originalBindEventListeners(); 
        
        // Add bindings for module-specific views
        bindJournalHandlers();
        bindWorkbookHandlers();
        bindReflectionHandlers();
    };

    // Attach the bootstrap function to the window to be called by a non-module script later
    window.AppBootstrap = App.bootstrap;

    // Register Service Worker
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(function(reg) {
          console.log('Service Worker Registered');
        })
        .catch(function(err) {
          console.log('Service Worker Registration Failed:', err);
        });
    }
    // --- END: MODULAR JAVASCRIPT REFACTOR ---
  </script>
  
  <!-- FIX: Final Non-Module Script to Guarantee Execution After DOM Load -->
  <script>
    // This non-module script runs *after* all HTML is parsed and module loading is initiated.
    // It calls the App.bootstrap() function exposed by the module system.
    if (window.AppBootstrap) {
        window.AppBootstrap();
    } else {
        // Fallback for extreme cases where module loading is delayed/broken
        document.addEventListener('DOMContentLoaded', () => {
            if (window.AppBootstrap) window.AppBootstrap();
        });
    }
  </script>
</body>
</html>
