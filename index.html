<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- UPDATED: Title for the application -->
  <title>The Addicts Agenda</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #f7f7f9;
      --card-radius: 16px;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --color-blue: #2b77f0;
      --color-shadow: rgba(43, 119, 240, 0.3);
      /* Define a neutral gray for secondary text/borders, now darker for contrast */
      --color-gray: #444; 
      --color-light-gray: #f0f0f0;
    }
    html,body{height:100%;margin:0;font-family:var(--font-family);background:linear-gradient(180deg,#f4f7fb,#ffffff);display:flex;align-items:center;justify-content:center}
    .app{width:100%;max-width:720px;padding:24px;box-sizing:border-box}
    .hero{background:#ffffff;padding:28px;border-radius:18px;box-shadow:0 6px 18px rgba(32,40,60,0.08);text-align:center; position: relative; /* Added for cog positioning */ }
    h1{margin:0;font-size:28px}
    p.sub{color:#556;opacity:0.8;margin-top:8px}

    /* NEW: Settings Cog Positioning */
    .settings-container {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    button.settings-cog {
        font-size: 24px;
        color: var(--color-gray); /* Dark gray color */
        padding: 5px;
        transition: transform 0.3s;
        background: none;
        border: none;
        cursor: pointer;
    }
    button.settings-cog:hover {
        transform: rotate(30deg);
    }
    .settings-group h3 {
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #333;
        text-align: left;
    }

    /* Primary Blue Button Style */
    button.primary{margin-top:20px;padding:14px 20px;border-radius:12px;border:0;background:var(--color-blue);color:#fff;font-size:18px;font-weight:600;width:100%;box-shadow:0 6px 16px var(--color-shadow);cursor:pointer;transition:background 0.2s}
    button.primary:hover{background:#2361c4}

    /* NEW: Journal Button Style (Secondary prominence but on homepage) */
    button.journal-btn {
        margin-top: 15px;
        padding: 12px 18px;
        border-radius: 10px;
        border: 1px solid var(--color-blue);
        background: #fff;
        color: var(--color-blue);
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: background 0.2s;
    }
    button.journal-btn:hover {
        background: #f0f7ff;
    }


    /* Secondary/Action Buttons (Default) */
    button{cursor:pointer;background:none;border:none;color:var(--color-blue);font-size:16px;padding:8px;font-weight:500}
    
    /* UPDATED: Secondary style for shuffle/next/home buttons with high contrast */
    button.secondary {
        /* Set background to white */
        background: #ffffff; 
        /* Set text color to a dark gray for high contrast */
        color: var(--color-gray); 
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
        /* Give it a subtle shadow to lift it off the card background */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        border: 1px solid #d0d0d0;
    }
    button.secondary:hover {
        background: #f5f5f5;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    /* ADDED FOR ACCESSIBILITY */
    button:focus-visible {
      outline: 2px solid var(--color-blue);
      outline-offset: 2px;
    }
    input[type="date"] {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: var(--font-family);
        font-size: 16px;
        box-sizing: border-box;
    }

    /* Fact Box Styling */
    .fact-box {
        margin-top: 30px;
        padding: 20px;
        background: #f0f7ff;
        border: 1px solid #d0e4ff;
        border-radius: 12px;
        text-align: center;
    }
    .fact-box h2 {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-blue);
        margin-top: 0;
        margin-bottom: 10px;
    }
    .fact-box p {
        font-size: 16px;
        color: #444;
        margin: 0;
        font-style: italic;
    }

    /* Card View Styles */
    .card-area{min-height:360px;background:#fff;border-radius:var(--card-radius);padding:40px 24px 24px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(32,40,60,0.08);text-align:center; transition: background 0.5s ease;}
    #cardIcon{font-size:80px;line-height:1;margin-bottom:12px; color: #fff;}
    #cardSuit{font-size:24px;font-weight:600;text-transform:uppercase;color:#fff}
    #cardText{font-size:24px;font-weight:500;margin:20px 0 40px;padding:0 20px;color:#fff}
    .actions button{margin:0 10px}
    .status-text{font-size:14px;color:#777;margin-top:10px}

    /* Journal View Styles */
    .journal-content {
        background: #ffffff;
        padding: 24px;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(32,40,60,0.08);
    }
    .journal-content h2 {
        font-size: 24px;
        margin-top: 0;
        color: #333;
        text-align: center;
    }
    textarea {
        width: 100%;
        height: 300px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: var(--font-family);
        font-size: 16px;
        resize: vertical;
        box-sizing: border-box;
        margin-top: 15px;
    }
    .journal-actions {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .journal-entry-list {
        list-style: none;
        padding: 0;
        margin-top: 20px;
    }
    .journal-entry-list li {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.1s;
        font-size: 16px;
    }
    .journal-entry-list li:hover {
        background: #f9f9f9;
    }
    .journal-entry-list li:last-child {
        border-bottom: none;
    }
    .list-view-actions {
        display: flex;
        gap: 10px;
    }
    .list-view-actions button {
        margin: 0;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" style="display:block;">
        <div class="hero">
            <!-- NEW: Settings Cog -->
            <div class="settings-container">
                <button id="goToSettingsBtn" class="settings-cog" title="Settings">&#x2699;</button>
            </div>
            
            <h1>The Addicts Agenda</h1>
            <p class="sub">Find inspiration and practical tools for your recovery journey.</p>
            
            <div class="fact-box">
                <h2>Recovery Fact of the Day</h2>
                <p id="dailyFactText">Loading daily inspiration...</p>
            </div>

            <!-- Button to Coping Cards -->
            <button id="goToCardsBtn" class="primary">Go to Coping Cards</button>

            <!-- Button to Journal Page -->
            <button id="goToJournalBtn" class="journal-btn">Start Journaling</button>
        </div>
    </div>
    
    <!-- 2. CARD INTRO SCREEN (Unused) -->
    <div id="cardIntro" style="display:none;">
      <div class="hero">
        <h1>52 Coping Cards</h1>
        <p class="sub">Need a quick strategy to manage a craving? Draw a card.</p>
        <button id="drawBtn" class="primary">Draw a Card</button>
      </div>
    </div>
    
    <!-- 3. CARD VIEW SCREEN -->
    <div id="cardView" style="display:none;">
      <div id="cardArea" class="card-area">
        <div>
          <span id="cardIcon"></span>
          <div id="cardSuit"></div>
        </div>
        <p id="cardText"></p>
        <div class="actions">
          <button id="nextBtn" class="secondary">Next Card</button>
          <button id="resetBtn" class="secondary">Home</button>
        </div>
        <div id="statusText" class="status-text"></div>
      </div>
    </div>

    <!-- 4. JOURNAL VIEW SCREEN -->
    <div id="journalView" style="display:none;">
        <div class="journal-content">
            
            <!-- Journal List View (initially hidden) -->
            <div id="journalList" style="display:none;">
                <h2>Journal Entries</h2>
                <div class="list-view-actions">
                    <button id="openListHomeBtn" class="secondary">Home</button>
                    <button id="newEntryBtn" class="secondary">Write Today's Entry</button>
                </div>
                <ul id="entryList" class="journal-entry-list">
                    <li>No entries saved yet.</li>
                </ul>
            </div>

            <!-- Journal Entry View (today's entry) -->
            <div id="journalEntryView">
                <h2>Today's Reflection</h2>
                <p class="sub" style="text-align: center;">Use this space to process cravings, track progress, or reflect on your card.</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="entryDate">Date:</label>
                    <input type="date" id="entryDate">
                </div>

                <textarea id="journalEntry" placeholder="What's on your mind today?"></textarea>
                
                <div class="journal-actions">
                    <button id="viewAllEntriesBtn" class="secondary">View All Entries</button>
                    <div class="list-view-actions">
                        <button id="saveJournalBtn" class="secondary">Save Entry</button>
                        <button id="entryHomeBtn" class="secondary">Home</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. NEW SETTINGS VIEW SCREEN -->
    <div id="settingsView" style="display:none;">
        <div class="journal-content">
            <h2>App Settings</h2>
            <div class="settings-group">
                <p class="sub" style="text-align: center; margin-bottom: 20px;">Track your journey.</p>
                <h3>Sober Date Tracking</h3>
                <label for="soberDateInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Your Sober Date:</label>
                <input type="date" id="soberDateInput" style="width: 100%; margin-bottom: 20px;">
                <p id="sobrietyDuration" style="font-size: 1.1em; font-weight: bold; text-align: center; color: var(--color-blue); min-height: 20px;"></p>
            </div>
            <div class="journal-actions" style="justify-content: flex-end; gap: 10px;">
                <button id="saveSettingsBtn" class="secondary">Save Date</button>
                <button id="settingsHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>

  </div>
  
  <script>
    const cards = [
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Tense and then relax your muscles. Repeat 3 times.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do 10 jumping jacks or jog in place for 30 seconds.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Stretch your entire body for 60 seconds.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Go for a walk, even if it is just a lap around the house.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Take 5 deep breaths, focusing only on the air moving in and out.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Clean an area of your home for 5 minutes (e.g., wash a few dishes).'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do a quick chore like taking out the trash or folding one piece of laundry.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Drink a full glass of water or a soothing hot beverage.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Splash cold water on your face.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Change your location. Move to another room or step outside.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do a 2-minute wall sit or plank.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Hold ice in your hand for a minute until the feeling subsides.'},
      {suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Eat a small, healthy snack, like a piece of fruit.'},
      
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Use a grounding technique. Name 5 things you see, 4 you touch, 3 you hear, 2 you smell, 1 you taste.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Write down three things you are grateful for right now.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Picture a favorite memory, like a vacation or a celebration. Focus on the details.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Say a positive affirmation out loud 10 times.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Watch a funny video or read a lighthearted article.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Try to recall the lyrics to your favorite song, word for word.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Look at a complex image or pattern and try to find a repeating element.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Do a quick Sudoku or word search puzzle.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Listen to a guided meditation for 5 minutes.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Imagine the feeling of the craving passing and how good it will feel.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Read a book or news article for 5 minutes.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Do a body scan. Focus on each part of your body from head to toe.'},
      {suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Mentally list all the cities or states you can remember.'},

      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Call or text a supportive friend or family member.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Check in with your sponsor or accountability partner.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Send a quick encouraging text to someone else in recovery.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Write down a commitment you can share with a friend later.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Read a few passages from an inspirational book or literature.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Go online to find a quick, virtual support meeting.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Write a quick email or note to thank someone in your life.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Say your name and what you are feeling right now out loud to an empty room.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Think about who in your life you could help with something small today.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Reach out to a professional (therapist, doctor) for advice if the craving persists.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Talk to a pet or plant for 5 minutes.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Offer a genuine compliment to a stranger or person nearby.'},
      {suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Read through old notes or cards from loved ones.'},

      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Write a short story or poem about your current feeling.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Listen to a piece of classical music youâ€™ve never heard before.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Draw or doodle for 5 minutes without judging the result.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Watch a short documentary or educational video on a random topic.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Pick up a new musical instrument (even a simple one like a harmonica) and try it.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Look up a recipe and plan to make it later this week.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Browse an online museum or art gallery.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Start a journal entry about your goals for the next month.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Learn a few words in a new language using an app or website.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Write down the ABCs backwards.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Look up the definition of a word you donâ€™t know and use it in a sentence.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Do something tactile, like playing with modeling clay or sand.'},
      {suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Try to balance an object on your finger for 60 seconds.'}
    ];

    // Array of Pop Culture Recovery Facts
    const POP_FACTS = [
        "In his recovery, actor Robert Downey Jr. pursued martial arts and therapy, stating: 'Job one is get out of that cave.'",
        "Actress Jamie Lee Curtis became addicted to prescription painkillers after a cosmetic surgery but has been sober since 1999, crediting her sobriety with giving her everything of value in her life.",
        "Bradley Cooper, who has been sober since 2004, credits his sobriety with saving his career and allowing him to become an A-list actor.",
        "Musician Elton John, who entered recovery in 1990, established the Elton John AIDS Foundation two years later, using his energy to help others.",
        "Actor Daniel Radcliffe sought sobriety in 2010 to cope with anxiety and stress after the Harry Potter series wrapped up, finding greater peace without alcohol.",
        "After battling substance abuse in her youth, Drew Barrymore went to rehab at age 13 and is now a successful actress and talk show host, openly sharing her journey.",
        "Actor Danny Trejo has been sober for over 50 years, having gotten clean well before his career took off.",
        "Samuel L. Jackson got sober in the early 1990s, realizing his acting career would require it, and has since become one of Hollywood's most successful actors.",
    ];

    let deck = [...cards]; // Full set of cards, initially available
    let currentJournalKey = '';

    // --- Journal Storage Functions ---
    const JOURNAL_KEY = 'addictsAgendaJournalEntries';
    const SOBER_DATE_KEY = 'soberDate'; // NEW KEY for sober date

    function getSavedEntries() {
        const entriesJson = localStorage.getItem(JOURNAL_KEY);
        return entriesJson ? JSON.parse(entriesJson) : {};
    }

    function saveEntry(dateKey, content) {
        const entries = getSavedEntries();
        entries[dateKey] = content;
        localStorage.setItem(JOURNAL_KEY, JSON.stringify(entries));
    }

    function loadEntry(dateKey) {
        const entries = getSavedEntries();
        return entries[dateKey] || '';
    }

    // --- Date/Time Helpers ---
    function getFormattedDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months start at 0
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function formatDateForDisplay(dateKey) {
        const parts = dateKey.split('-');
        if (parts.length === 3) {
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        return dateKey; // Fallback
    }

    function calculateDuration(soberDateStr) {
        if (!soberDateStr) return "Enter your date to start tracking!";
        
        const start = new Date(soberDateStr);
        const now = new Date();
        
        if (start > now) return "Date must be in the past.";

        const diffTime = Math.abs(now - start);
        
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const days = Math.floor(diffTime / MS_PER_DAY);
        
        const years = Math.floor(days / 365.25);
        const remainingDays = days % 365.25;
        const months = Math.floor(remainingDays / 30.44); // Average days per month
        const actualDays = Math.floor(remainingDays % 30.44);

        let output = "Sober for: ";
        if (years > 0) output += `${years} year${years !== 1 ? 's' : ''}, `;
        if (months > 0) output += `${months} month${months !== 1 ? 's' : ''}, and `;
        output += `${days} day${days !== 1 ? 's' : ''} total.`;
        
        return output;
    }

    // --- Settings Logic ---
    function loadSoberDate() {
        return localStorage.getItem(SOBER_DATE_KEY) || '';
    }

    function saveSoberDate(dateStr) {
        localStorage.setItem(SOBER_DATE_KEY, dateStr);
        document.getElementById('sobrietyDuration').textContent = calculateDuration(dateStr);
    }

    function showSettingsView() {
        displayAppView('settingsView');
        const soberDateInput = document.getElementById('soberDateInput');
        
        // Load and display current date/duration
        const savedDate = loadSoberDate();
        soberDateInput.value = savedDate;
        soberDateInput.max = getFormattedDate(new Date());
        document.getElementById('sobrietyDuration').textContent = calculateDuration(savedDate);
    }

    // --- Journal View Logic ---
    function showJournalEntryView(dateKey = null) {
        document.getElementById('journalEntryView').style.display = 'block';
        document.getElementById('journalList').style.display = 'none';

        const today = new Date();
        if (dateKey === null) {
            dateKey = getFormattedDate(today);
        }

        currentJournalKey = dateKey;
        document.getElementById('entryDate').value = dateKey;
        document.getElementById('journalEntry').value = loadEntry(dateKey);
        document.querySelector('#journalEntryView h2').textContent = formatDateForDisplay(new Date(dateKey));
    }

    function showJournalListView() {
        document.getElementById('journalEntryView').style.display = 'none';
        document.getElementById('journalList').style.display = 'block';
        renderEntryList();
    }

    function renderEntryList() {
        const entries = getSavedEntries();
        const entryListElement = document.getElementById('entryList');
        entryListElement.innerHTML = '';
        const sortedKeys = Object.keys(entries).sort().reverse(); // Sort descending by date

        if (sortedKeys.length === 0) {
            entryListElement.innerHTML = '<li>No entries saved yet.</li>';
            return;
        }

        sortedKeys.forEach(key => {
            const li = document.createElement('li');
            li.textContent = formatDateForDisplay(key);
            li.setAttribute('data-date-key', key);
            
            const viewButton = document.createElement('button');
            viewButton.textContent = 'View';
            viewButton.classList.add('secondary');
            viewButton.style.marginLeft = '10px';
            
            viewButton.onclick = () => {
                showJournalEntryView(key);
            };

            li.appendChild(viewButton);
            entryListElement.appendChild(li);
        });
    }

    // --- Core App Functions ---

    // UPDATED: Function now returns a bold, two-color linear gradient string. Changed 'orange' to a darker red gradient.
    function suitColor(suit_key){
      switch(suit_key){
        case 'blue': return 'linear-gradient(135deg, #5B86E5 0%, #36D1DC 100%)'; // Action & Movement
        case 'green': return 'linear-gradient(135deg, #2ECC71 0%, #56C87C 100%)'; // Mind & Focus
        case 'orange': return 'linear-gradient(135deg, #C0392B 0%, #E74C3C 100%)'; // Connection & Support (Darker Red)
        case 'purple': return 'linear-gradient(135deg, #A569BD 0%, #D2B4DE 100%)'; // Creative & Learning
        default: return '#fff';
      }
    }

    function updateStatus(){
      document.getElementById('statusText').textContent = `Cards left in deck: ${deck.length} / 52`;
    }

    function renderCard(c){
      document.getElementById('cardIcon').textContent = c.icon;
      document.getElementById('cardSuit').textContent = c.suit;
      document.getElementById('cardText').textContent = c.text;
      // Set background using the new gradient
      document.getElementById('cardArea').style.background = suitColor(c.suit_key);
      updateStatus();
    }

    function drawRandom(){
      if(deck.length === 0) return null;
      const idx = Math.floor(Math.random()*deck.length);
      const card = deck.splice(idx,1)[0];
      return card;
    }
    
    function displayAppView(viewId) {
        document.getElementById('homeScreen').style.display = 'none';
        document.getElementById('cardIntro').style.display = 'none';
        document.getElementById('cardView').style.display = 'none';
        document.getElementById('journalView').style.display = 'none'; 
        document.getElementById('settingsView').style.display = 'none'; // NEW: Hide Settings View
        document.getElementById(viewId).style.display = 'block';
    }
    
    // Function to draw a card and display the card view
    function drawAndDisplayCard() {
        const card = drawRandom();
        if (!card) {
            console.log('Deck empty â€” shuffle or reset.');
            alert('Deck empty â€” please shuffle or return home.');
            return;
        }
        renderCard(card);
        displayAppView('cardView');
    }

    function getDailyFact() {
        // Use the day of the year to cycle through facts
        const today = new Date();
        const start = new Date(today.getFullYear(), 0, 0);
        const diff = today - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        
        const factIndex = dayOfYear % POP_FACTS.length;
        document.getElementById('dailyFactText').textContent = POP_FACTS[factIndex];
    }


    // --- Event Listeners ---
    
    // 1. Home Screen: Go to Coping Cards Button
    document.getElementById('goToCardsBtn').addEventListener('click', ()=>{
      drawAndDisplayCard();
    });

    // 2. Home Screen: Go to Settings Button (NEW)
    document.getElementById('goToSettingsBtn').addEventListener('click', ()=>{
      showSettingsView();
    });
    
    // 3. Home Screen: Go to Journal Page Button
    document.getElementById('goToJournalBtn').addEventListener('click', ()=>{
      displayAppView('journalView');
      showJournalEntryView(); // Default to today's entry view
    });

    // 4. Card View: Next Card Button
    document.getElementById('nextBtn').addEventListener('click', ()=>{
      drawAndDisplayCard();
    });
    
    // 5. Card View: Home Button
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      deck = [...cards];
      displayAppView('homeScreen');
      updateStatus();
    });
    
    // 6. Journal View: Home Button (on Entry View)
    document.getElementById('entryHomeBtn').addEventListener('click', ()=>{
        displayAppView('homeScreen');
    });

    // 7. Journal View: Home Button (on List View)
    document.getElementById('openListHomeBtn').addEventListener('click', ()=>{
        displayAppView('homeScreen');
    });
    
    // 8. Journal View: Save Entry Button
    document.getElementById('saveJournalBtn').addEventListener('click', ()=>{
      const content = document.getElementById('journalEntry').value;
      const dateKey = document.getElementById('entryDate').value;
      
      if (content.trim() === '') {
        alert('Journal entry cannot be empty.');
        return;
      }
      
      if (dateKey) {
        saveEntry(dateKey, content);
        console.log('Journal Entry Saved:', dateKey, content);
        alert(`Entry for ${dateKey} Saved!`);
      } else {
        alert('Please select a date.');
      }
    });
    
    // 9. Journal View: Date Change Listener
    document.getElementById('entryDate').addEventListener('change', (event) => {
        const dateKey = event.target.value;
        if (dateKey) {
            showJournalEntryView(dateKey);
        }
    });

    // 10. Journal View: View All Entries Button
    document.getElementById('viewAllEntriesBtn').addEventListener('click', ()=>{
        showJournalListView();
    });
    
    // 11. Journal View: New Entry Button (from List View)
    document.getElementById('newEntryBtn').addEventListener('click', ()=>{
        showJournalEntryView();
    });

    // 12. Settings View: Save Settings Button (NEW)
    document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{
        const dateStr = document.getElementById('soberDateInput').value;
        if (dateStr && new Date(dateStr) <= new Date()) {
            saveSoberDate(dateStr);
            alert('Sober Date Saved!');
        } else {
            alert('Please enter a valid Sober Date in the past.');
        }
    });

    // 13. Settings View: Home Button (NEW)
    document.getElementById('settingsHomeBtn').addEventListener('click', ()=>{
        displayAppView('homeScreen');
    });


    // --- Initialization ---
    function initializeApp() {
        getDailyFact();
        updateStatus();
        
        // Set max date for input to today
        const todayKey = getFormattedDate(new Date());
        document.getElementById('entryDate').max = todayKey;
        document.getElementById('soberDateInput').max = todayKey;

        // Ensure the home screen is the default view on load
        displayAppView('homeScreen');
    }

    initializeApp();


    // Register Service Worker
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(function(reg) {
          console.log('Service Worker Registered');
        })
        .catch(function(err) {
          console.log('Service Worker Registration Failed:', err);
        });
    }
  </script>
</body>
</html>
