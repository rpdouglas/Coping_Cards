<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- UPDATED: Title for the application -->
  <title>The Addicts Agenda</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #f7f7f9;
      --card-radius: 16px;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --color-blue: #2b77f0;
      --color-shadow: rgba(43, 119, 240, 0.3);
      /* Define a neutral gray for secondary text/borders, now darker for contrast */
      --color-gray: #444; 
      --color-light-gray: #f0f0f0;
    }
    /* FIX: Remove height:100% from html,body and allow the body to scroll */
    html,body{margin:0;font-family:var(--font-family);background:linear-gradient(180deg,#f4f7fb,#ffffff);display:flex;align-items:center;justify-content:center; min-height: 100vh;}
    .app{width:100%;max-width:720px;padding:24px;box-sizing:border-box}
    .hero{background:#ffffff;padding:28px;border-radius:18px;box-shadow:0 6px 18px rgba(32,40,60,0.08);text-align:center; position: relative; /* Added for cog positioning */ }
    h1{margin:0;font-size:28px}
    p.sub{color:#556;opacity:0.8;margin-top:8px}

    /* NEW: Version Number Positioning */
    #appVersion {
        position: absolute;
        top: 15px;
        left: 15px;
        font-size: 14px;
        color: #888;
        font-weight: 500;
    }

    /* NEW: Settings Cog Positioning */
    .settings-container {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    button.settings-cog {
        font-size: 24px;
        color: var(--color-gray); /* Dark gray color */
        padding: 5px;
        transition: transform 0.3s;
        background: none;
        border: none;
        cursor: pointer;
    }
    button.settings-cog:hover {
        transform: rotate(30deg);
    }
    .settings-group h3 {
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #333;
        text-align: left;
    }

    /* Primary Blue Button Style (Used for Cards, Journal, and To Do List) */
    button.primary{margin-top:20px;padding:14px 20px;border-radius:12px;border:0;background:var(--color-blue);color:#fff;font-size:18px;font-weight:600;width:100%;box-shadow:0 6px 16px var(--color-shadow);cursor:pointer;transition:background 0.2s; text-align: center;} /* Default centered text */
    button.primary:hover{background:#2361c4}
    
    /* WORKBOOKS PAGE BUTTON FIX: Align text left only for workbook buttons */
    #workbooksView button.primary {
        text-align: left;
        padding-left: 20px;
    }
    
    /* NEW: Reflection Button Group Styling */
    .reflection-group {
        display: flex;
        gap: 15px; /* Spacing between the two reflection buttons */
        margin-top: 15px;
    }
    .reflection-group button.primary {
        margin-top: 0;
        width: 50%; /* Make them share the width */
        padding-left: 10px;
        padding-right: 10px;
    }


    /* Secondary/Action Buttons (Default) */
    button{cursor:pointer;background:none;border:none;color:var(--color-blue);font-size:16px;padding:8px;font-weight:500}
    
    /* UPDATED: Secondary style for next/home buttons with high contrast */
    button.secondary {
        /* Set background to white */
        background: #ffffff; 
        /* Set text color to a dark gray for high contrast */
        color: var(--color-gray); 
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
        /* Give it a subtle shadow to lift it off the card background */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        border: 1px solid #d0d0d0;
    }
    button.secondary:hover {
        background: #f5f5f5;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    /* ADDED FOR ACCESSIBILITY */
    button:focus-visible {
      outline: 2px solid var(--color-blue);
      outline-offset: 2px;
    }
    input[type="date"], input[type="text"], select {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: var(--font-family);
        font-size: 16px;
        box-sizing: border-box;
    }
    select {
        width: 100%;
        cursor: pointer;
    }

    /* Fact Box Styling */
    .fact-box {
        margin-top: 30px;
        padding: 20px;
        background: #f0f7ff;
        border: 1px solid #d0e4ff;
        border-radius: 12px;
        text-align: center;
    }
    .fact-box h2 {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-blue);
        margin-top: 0;
        margin-bottom: 10px;
    }
    .fact-box p {
        font-size: 16px;
        color: #444;
        margin: 0;
        font-style: italic;
    }
    
    /* Sobriety Duration on Home Screen */
    #homeSobrietyDuration {
        margin: 15px 0 0 0;
        font-size: 1.1em;
        font-weight: 600;
        color: #555;
    }

    /* Card View Styles */
    .card-area{min-height:360px;background:#fff;border-radius:var(--card-radius);padding:40px 24px 24px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(32,40,60,0.08);text-align:center; transition: background 0.5s ease;}
    #cardIcon{font-size:80px;line-height:1;margin-bottom:12px; color: #fff;}
    #cardSuit{font-size:24px;font-weight:600;text-transform:uppercase;color:#fff}
    #cardText{font-size:24px;font-weight:500;margin:20px 0 40px;padding:0 20px;color:#fff}
    .actions button{margin:0 10px}
    .status-text{font-size:14px;color:#777;margin-top:10px}

    /* Shared Content Styles */
    .content-card {
        background: #ffffff;
        padding: 24px;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(32,40,60,0.08);
        /* FIX: Allow content cards to grow vertically without height constraints */
        width: 100%;
        box-sizing: border-box;
    }
    .content-card h2 {
        font-size: 24px;
        margin-top: 0;
        color: #333;
        text-align: center;
    }
    textarea {
        width: 100%;
        height: 300px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: var(--font-family);
        font-size: 16px;
        resize: vertical;
        box-sizing: border-box;
        margin-top: 15px;
    }
    .actions-row {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .list-view-actions {
        display: flex;
        gap: 10px;
    }
    .list-view-actions button {
        margin: 0;
    }
    .prompt-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    /* To Do List Specific Styles */
    .todo-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px; /* Reduced margin */
        flex-wrap: wrap;
    }
    .todo-input-group input[type="text"] {
        flex-grow: 1;
        min-width: 150px;
    }
    /* NEW: Styling for recurrence and date inputs in the task form */
    .todo-input-group input[type="date"], .todo-input-group select {
        width: auto;
        flex-grow: 0;
        min-width: 100px;
    }
    .todo-list {
        list-style: none;
        padding: 0;
        margin-top: 0;
    }
    .todo-list li {
        display: flex;
        flex-direction: column; /* Stack details vertically */
        align-items: flex-start;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .todo-list li:last-child {
        border-bottom: none;
    }
    .todo-main-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .todo-text {
        flex-grow: 1;
        cursor: pointer;
        padding: 0 5px;
        font-weight: 500;
    }
    .todo-details {
        font-size: 0.9em;
        color: #777;
        margin-top: 5px;
    }
    .todo-completed {
        text-decoration: line-through;
        color: #888;
    }
    /* Prompt Manager Styles */
    .prompt-list-manager li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    /* Workbook Styles */
    .workbook-question {
        margin-bottom: 30px;
        border-left: 3px solid var(--color-blue);
        padding-left: 15px;
    }
    .workbook-question h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
    }
    .workbook-question textarea {
        height: 150px;
        margin-top: 0;
    }
    
    /* NEW: Collapsible styles for Workbook */
    .workbook-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        margin: 20px -24px 0 -24px; /* Extend full width of content-card */
        background-color: var(--color-light-gray);
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        font-size: 1.2em;
        font-weight: 700;
        color: #333;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .workbook-section-header:hover {
        background-color: #e5e5e5;
    }
    .workbook-section-header h3 {
        margin: 0;
        font-size: 1em; /* Use 1em since parent is 1.2em */
    }
    .collapse-icon {
        font-size: 1.5em;
        transition: transform 0.3s;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    .section-content {
        max-height: 2000px; /* large enough for content */
        overflow: hidden;
        transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
    }
    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
    }

    /* Literature Styles */
    .literature-chapter {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    .literature-chapter h3 {
        color: var(--color-blue);
        border-bottom: 2px solid var(--color-blue);
        padding-bottom: 5px;
        margin-top: 0;
        font-size: 1.4em;
    }
    .literature-chapter p {
        text-align: justify;
        line-height: 1.6;
        color: #555;
        margin-top: 15px;
    }
    .literature-link {
        display: block;
        margin-top: 30px;
        text-align: center;
        font-style: italic;
    }

    /* Daily Reflection Styles */
    #reflectionContent {
        min-height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 15px;
        background: #f7f7f9;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-top: 15px;
    }

    #reflectionDateInput {
        max-width: 200px;
        margin: 15px auto 5px auto;
        display: block;
    }

    #reflectionQuote {
        font-size: 1.2em;
        font-style: italic;
        color: #333;
        margin-bottom: 15px;
    }
    #reflectionReading {
        color: #555;
        line-height: 1.6;
    }
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--color-blue);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" style="display:block;">
        <div class="hero">
            <!-- NEW: App Version Number -->
            <div id="appVersion">V0.2</div>

            <!-- NEW: Settings Cog -->
            <div class="settings-container">
                <button id="goToSettingsBtn" class="settings-cog" title="Settings">&#x2699;</button>
            </div>
            
            <h1>The Addicts Agenda</h1>
            <p class="sub">Find inspiration and practical tools for your recovery journey.</p>
            
            <!-- NEW: Sobriety Duration Display -->
            <p id="homeSobrietyDuration" style="color: var(--color-blue);">Set your sober date in Settings.</p>
            
            <div class="fact-box">
                <h2>Recovery Fact of the Day</h2>
                <p id="dailyFactText">Loading daily inspiration...</p>
            </div>

            <!-- Button 1: Draw Coping Cards (Text Changed) -->
            <button id="goToCardsBtn" class="primary">Draw a Coping Card</button>

            <!-- Button 2: Start Journaling (Style Changed to Primary) -->
            <button id="goToJournalBtn" class="primary" style="margin-top: 15px;">Start Journaling</button>
            
            <!-- Button 3: To Do List (NEW) -->
            <button id="goToTodoBtn" class="primary" style="margin-top: 15px;">View To Do List</button>
            
            <!-- NEW Button Group for Reflections -->
            <div class="reflection-group">
                <!-- Button 4: Daily Reflection -->
                <button id="goToReflectionBtn" class="primary">Daily Reflection (AA)</button>
                <!-- NEW Button 5: Just For Today -->
                <button id="goToJFTBtn" class="primary">Just for Today (NA)</button>
            </div>


            <!-- NEW Button 6: Recovery Literature -->
            <button id="goToLiteratureBtn" class="primary" style="margin-top: 15px;">Recovery Literature</button>

            <!-- NEW Button 7: Recovery Workbooks -->
            <button id="goToWorkbooksBtn" class="primary" style="margin-top: 15px;">Recovery Workbooks</button>
        </div>
    </div>
    
    <!-- 2. CARD INTRO SCREEN (Unused) -->
    <div id="cardIntro" style="display:none;">
      <div class="hero">
        <h1>52 Coping Cards</h1>
        <p class="sub">Need a quick strategy to manage a craving? Draw a card.</p>
        <button id="drawBtn" class="primary">Draw a Card</button>
      </div>
    </div>
    
    <!-- 3. CARD VIEW SCREEN -->
    <div id="cardView" style="display:none;">
      <div id="cardArea" class="card-area">
        <div>
          <span id="cardIcon"></span>
          <div id="cardSuit"></div>
        </div>
        <p id="cardText"></p>
        <div class="actions">
          <button id="nextBtn" class="secondary">Next Card</button>
          <button id="resetBtn" class="secondary">Home</button>
        </div>
        <div id="statusText" class="status-text"></div>
      </div>
    </div>

    <!-- 4. JOURNAL VIEW SCREEN -->
    <div id="journalView" style="display:none;">
        <div class="content-card">
            
            <!-- Journal List View (initially hidden) -->
            <div id="journalList" style="display:none;">
                <h2>Journal Entries</h2>
                <div class="list-view-actions">
                    <button id="openListHomeBtn" class="secondary">Home</button>
                    <button id="newEntryBtn" class="secondary">Write Today's Entry</button>
                </div>
                <ul id="entryList" class="journal-entry-list">
                    <li>No entries saved yet.</li>
                </ul>
            </div>

            <!-- Journal Prompt Manager (NEW, initially hidden) -->
            <div id="promptManagerView" style="display:none;">
                <h2>Manage Custom Prompts</h2>
                <div class="prompt-row">
                    <input type="text" id="customPromptInput" placeholder="Enter new prompt text (e.g., What did I learn today?)" style="flex-grow: 1;">
                    <button id="addCustomPromptBtn" class="secondary">Add</button>
                </div>
                <p class="sub" style="text-align: center;">Click a prompt below to delete it.</p>
                <ul id="customPromptList" class="journal-entry-list prompt-list-manager">
                    <!-- Custom Prompts will be rendered here -->
                </ul>
                <div class="actions-row" style="justify-content: flex-end; margin-top: 20px;">
                    <button id="backToEntryBtn" class="secondary">Back to Journal</button>
                </div>
            </div>

            <!-- Journal Entry View (today's entry) -->
            <div id="journalEntryView">
                <h2>Today's Reflection</h2>
                <p class="sub" style="text-align: center;">Use this space to process cravings, track progress, or reflect on your card.</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="entryDate">Date:</label>
                    <input type="date" id="entryDate">
                </div>
                
                <div class="prompt-row" style="margin-top: 15px;">
                    <select id="promptSelect">
                        <!-- Prompts loaded here -->
                    </select>
                    <button id="managePromptsBtn" class="secondary">Manage Prompts</button>
                </div>

                <textarea id="journalEntry" placeholder="What's on your mind today?"></textarea>
                
                <div class="actions-row">
                    <button id="viewAllEntriesBtn" class="secondary">View All Entries</button>
                    <div class="list-view-actions">
                        <button id="saveJournalBtn" class="secondary">Save Entry</button>
                        <button id="entryHomeBtn" class="secondary">Home</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. SETTINGS VIEW SCREEN -->
    <div id="settingsView" style="display:none;">
        <div class="content-card">
            <h2>App Settings</h2>
            <div class="settings-group">
                <p class="sub" style="text-align: center; margin-bottom: 20px;">Track your journey.</p>
                <h3>Sober Date Tracking</h3>
                <label for="soberDateInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Your Sober Date:</label>
                <input type="date" id="soberDateInput" style="width: 100%; margin-bottom: 20px;">
                <p id="sobrietyDuration" style="font-size: 1.1em; font-weight: bold; text-align: center; color: var(--color-blue); min-height: 20px;"></p>
            </div>
            <div class="actions-row" style="justify-content: flex-end; gap: 10px;">
                <button id="saveSettingsBtn" class="secondary">Save Date</button>
                <button id="settingsHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 6. NEW TO DO LIST VIEW SCREEN -->
    <div id="todoView" style="display:none;">
        <div class="content-card">
            <h2>My To Do List</h2>
            <p class="sub" style="text-align: center;">Keep track of small, actionable tasks.</p>
            
            <!-- NEW: Task Input Form with Date and Recurrence -->
            <div class="todo-input-group">
                <input type="text" id="todoInput" placeholder="Task description">
                <input type="date" id="todoDateInput">
                <select id="todoRecurrenceSelect">
                    <option value="none">No Repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Every 2 Weeks</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button id="addTodoBtn" class="secondary">Add Task</button>
            </div>
            
            <ul id="todoList" class="todo-list">
                <!-- To Do Items will be rendered here -->
            </ul>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px;">
                <button id="todoHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>

    <!-- 7. NEW RECOVERY LITERATURE VIEW SCREEN -->
    <div id="literatureView" style="display:none;">
        <div class="content-card">
            <h2>Recovery Literature: Big Book Excerpts</h2>
            <p class="sub" style="text-align: center;">Read key foundational texts from the fellowship.</p>
            
            <div id="literatureContent">
                <!-- Chapter 1: Bill's Story -->
                <div class="literature-chapter">
                    <h3>Chapter 1: Bill's Story</h3>
                    <p>Bill W.'s story is the compelling and historic account of how the co-founder of Alcoholics Anonymous discovered his powerlessness over alcohol and, through a spiritual experience and connection with others, found a way out. It details his struggles in the business world, his devastating descent into alcoholism, his institutionalization, and the transformative visit from his old friend, Ebby T. His realization that only a spiritual experience and helping others could provide lasting sobriety became the bedrock of the entire program.</p>
                </div>

                <!-- Chapter 2: There is a Solution -->
                <div class="literature-chapter">
                    <h3>Chapter 2: There is a Solution</h3>
                    <p>This chapter provides hope by asserting that recovery from alcoholism is possible. It emphasizes the importance of the fellowship (the "hundreds of men and women" who have recovered) and the fact that the solution lies not just in stopping drinking, but in a spiritual program of action. It introduces the core concept that alcoholism is a threefold disease—physical, mental, and spiritual—and that the spiritual malady requires a spiritual remedy, a practical method for living soberly.</p>
                </div>
            </div>

            <p class="literature-link">
                For the complete text, download the 
                <a href="https://aa-netherlands.org/for-members/big-book-online/" target="_blank" style="color: var(--color-blue); font-weight: 600;">Big Book Online (PDF)</a>.
            </p>

            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="literatureHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>

    <!-- 8. NEW RECOVERY WORKBOOKS VIEW SCREEN -->
    <div id="workbooksView" style="display:none;">
        <div class="content-card">
            <h2>Recovery Workbooks</h2>
            <p class="sub" style="text-align: center;">Tools and step work resources.</p>
            <!-- NEW: Button to Step 1 Workbook -->
            <button id="goToStep1Btn" class="primary" style="margin-top: 15px;">Step 1: Powerlessness & Unmanageability</button>
            <!-- NEW: Button to Step 2 Workbook -->
            <button id="goToStep2Btn" class="primary" style="margin-top: 15px;">Step 2: Coming to Believe</button>
            <!-- NEW: Button to Step 3 Workbook -->
            <button id="goToStep3Btn" class="primary" style="margin-top: 15px;">Step 3: Turning It Over</button>
            <!-- NEW: Button to Step 4 Workbook -->
            <button id="goToStep4Btn" class="primary" style="margin-top: 15px;">Step 4: Moral Inventory</button>
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="workbooksHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 9. NEW STEP ONE WORKBOOK VIEW SCREEN -->
    <div id="stepOneView" style="display:none;">
        <div class="content-card">
            <h2>Step 1: Admitted Powerlessness</h2>
            <p class="sub" style="text-align: center;">"We admitted we were powerless over cocaine and all other mind-altering substances—that our lives had become unmanageable."</p>
            
            <div id="stepOneQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepOneSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepOneBtn" class="secondary">Save Progress</button>
                    <button id="stepOneWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. NEW STEP TWO WORKBOOK VIEW SCREEN -->
    <div id="stepTwoView" style="display:none;">
        <div class="content-card">
            <h2>Step 2: Coming to Believe</h2>
            <p class="sub" style="text-align: center;">"We came to believe that a Power greater than ourselves could restore us to sanity."</p>
            
            <div id="stepTwoQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepTwoSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepTwoBtn" class="secondary">Save Progress</button>
                    <button id="stepTwoWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 11. NEW STEP THREE WORKBOOK VIEW SCREEN -->
    <div id="stepThreeView" style="display:none;">
        <div class="content-card">
            <h2>Step 3: Turning It Over</h2>
            <p class="sub" style="text-align: center;">"We made a decision to turn our will and our lives over to the care of God as we understood Him."</p>
            
            <div id="stepThreeQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepThreeSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepThreeBtn" class="secondary">Save Progress</button>
                    <button id="stepThreeWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 12. NEW STEP FOUR WORKBOOK VIEW SCREEN -->
    <div id="stepFourView" style="display:none;">
        <div class="content-card">
            <h2>Step 4: Moral Inventory</h2>
            <p class="sub" style="text-align: center;">"Made a searching and fearless moral inventory of ourselves."</p>
            
            <div id="stepFourQuestions">
                <!-- Questions and answers will be dynamically loaded here -->
            </div>
            
            <div class="actions-row">
                <p id="stepFourSaveStatus" style="color: green; font-weight: 600;"></p>
                <div class="list-view-actions">
                    <button id="saveStepFourBtn" class="secondary">Save Progress</button>
                    <button id="stepFourWorkbooksBtn" class="secondary">Workbooks Home</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 13. NEW DAILY REFLECTION VIEW SCREEN -->
    <div id="reflectionView" style="display:none;">
        <div class="content-card">
            <h2>Daily Reflection (AA)</h2>
            <p class="sub" style="text-align: center;">A daily quote and meditation to guide your thoughts.</p>
            
            <label for="reflectionDateInput" style="display: block; text-align: center; font-weight: 600; margin-top: 10px;">Select Date:</label>
            <input type="date" id="reflectionDateInput">

            <div id="reflectionContent">
                <div class="loading-spinner" id="reflectionSpinner"></div>
                <p id="reflectionQuote" style="display: none;">Quote goes here.</p>
                <p id="reflectionReading" style="display: none;">Reading goes here.</p>
            </div>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="reflectionHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>
    
    <!-- 14. NEW JUST FOR TODAY VIEW SCREEN -->
    <div id="jftView" style="display:none;">
        <div class="content-card">
            <h2>Just for Today (NA)</h2>
            <p class="sub" style="text-align: center;">The daily spiritual message from Narcotics Anonymous.</p>
            
            <label for="jftDateInput" style="display: block; text-align: center; font-weight: 600; margin-top: 10px;">Select Date:</label>
            <input type="date" id="jftDateInput">

            <div id="jftContent" style="min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 15px; background: #f7f7f9; border-radius: 10px; border: 1px solid #ddd; margin-top: 15px;">
                <div class="loading-spinner" id="jftSpinner"></div>
                <p id="jftQuote" style="display: none; font-size: 1.2em; font-style: italic; color: #333; margin-bottom: 15px;">Quote goes here.</p>
                <p id="jftReading" style="display: none; color: #555; line-height: 1.6;">Reading goes here.</p>
            </div>
            
            <div class="actions-row" style="justify-content: flex-end; gap: 10px; margin-top: 40px;">
                <button id="jftHomeBtn" class="secondary">Home</button>
            </div>
        </div>
    </div>


  </div>
  
  <script type="module">
    // --- START: MODULAR JAVASCRIPT ---
    
    // Import all necessary data and module helpers
    import { AppData } from './data.js';
    import { Storage } from './storage.js';
    // Journal Logic Imports
    import { JournalEventHandlers, showJournalEntryView, showJournalListView, showPromptManagerView } from './journal.js'; 
    
    // ----------------------------------------------------------------------
    // Global Constants and State (minimal)
    // ----------------------------------------------------------------------
    let deck = [...AppData.cards];
    const GEMINI_API_KEY = typeof __api_key !== 'undefined' ? __api_key : ""; 
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";


    // --- Date/Time Helpers ---
    const DateUtils = {
        getFormattedDate: (date) => {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        },
        formatDateForDisplayShort: (dateKey) => {
            if (!dateKey) return '';
            const date = new Date(dateKey);
            return date.toLocaleDateString('en-US'); 
        },
        formatDateForDisplay: (dateKey) => {
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                const date = new Date(parts[0], parts[1] - 1, parts[2]);
                return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            return dateKey;
        },
        calculateDuration: (soberDateStr) => {
            if (!soberDateStr) return "Enter your date to start tracking!";
            
            const start = new Date(soberDateStr);
            const now = new Date();
            
            if (start > now) return "Date must be in the past.";

            const diffTime = Math.abs(now - start);
            const MS_PER_DAY = 1000 * 60 * 60 * 24;
            const days = Math.floor(diffTime / MS_PER_DAY);
            
            const years = Math.floor(days / 365.25);
            const remainingDays = days % 365.25;
            const months = Math.floor(remainingDays / 30.44);
            
            let output = "Sober for: ";
            if (years > 0) output += `${years} year${years !== 1 ? 's' : ''}, `;
            if (months > 0) output += `${months} month${months !== 1 ? 's' : ''}, and `;
            output += `${days} day${days !== 1 ? 's' : ''} total.`;
            
            return output;
        }
    };
    
    // --- View Management ---
    const ViewManager = {
        displayAppView: (viewId) => {
            const views = ['homeScreen', 'cardIntro', 'cardView', 'journalView', 'settingsView', 'todoView', 'literatureView', 'workbooksView', 'stepOneView', 'stepTwoView', 'stepThreeView', 'stepFourView', 'reflectionView', 'jftView'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = id === viewId ? 'block' : 'none';
                }
            });
        },
        updateHomeSobrietyDuration: () => {
            const savedDate = Storage.loadSoberDate();
            document.getElementById('homeSobrietyDuration').textContent = DateUtils.calculateDuration(savedDate);
        },
        getDailyFact: () => {
            const factIndex = Math.floor(Math.random() * AppData.POP_FACTS.length);
            document.getElementById('dailyFactText').textContent = AppData.POP_FACTS[factIndex];
        }
    };

    // --- Card Logic ---
    const CardLogic = {
        suitColor: (suit_key) => {
            switch(suit_key){
                case 'blue': return 'linear-gradient(135deg, #5B86E5 0%, #36D1DC 100%)';
                case 'green': return 'linear-gradient(135deg, #2ECC71 0%, #56C87C 100%)';
                case 'orange': return 'linear-gradient(135deg, #C0392B 0%, #E74C3C 100%)';
                case 'purple': return 'linear-gradient(135deg, #A569BD 0%, #D2B4DE 100%)';
                default: return '#fff';
            }
        },
        updateStatus: () => {
            document.getElementById('statusText').textContent = `Cards left in deck: ${deck.length} / 52`;
        },
        renderCard: (card) => {
            document.getElementById('cardIcon').textContent = card.icon;
            document.getElementById('cardSuit').textContent = card.suit;
            document.getElementById('cardText').textContent = card.text;
            document.getElementById('cardArea').style.background = CardLogic.suitColor(card.suit_key);
            CardLogic.updateStatus();
        },
        drawRandom: () => {
            if(deck.length === 0) return null;
            const idx = Math.floor(Math.random()*deck.length);
            const card = deck.splice(idx,1)[0];
            return card;
        },
        drawAndDisplayCard: () => {
            const card = CardLogic.drawRandom();
            if (!card) {
                console.log('Deck empty — shuffle or reset.');
                alert('Deck empty — please shuffle or return home.');
                return;
            }
            CardLogic.renderCard(card);
            ViewManager.displayAppView('cardView');
        },
        resetDeck: () => {
            deck = [...AppData.cards];
            CardLogic.updateStatus();
            ViewManager.displayAppView('homeScreen');
        }
    };

    // --- To Do List Logic ---
    const TodoLogic = {
        getRecurrenceLabel: (key) => {
            switch(key) {
                case 'daily': return 'Daily';
                case 'weekly': return 'Weekly';
                case 'biweekly': return 'Bi-Weekly';
                case 'monthly': return 'Monthly';
                case 'yearly': return 'Yearly';
                default: return 'No Repeat';
            }
        },
        renderTodoList: () => {
            TodoLogic.updateRecurringTasks();
            const list = Storage.getTodoList().sort((a, b) => {
                if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                if (a.dueDate) return -1;
                if (b.dueDate) return 1;
                return 0;
            });

            const todoListElement = document.getElementById('todoList');
            todoListElement.innerHTML = '';

            if (list.length === 0) {
                todoListElement.innerHTML = '<li style="justify-content: center; color: #888;">Your list is clear!</li>';
                return;
            }

            list.forEach((item, index) => {
                const li = document.createElement('li');
                const mainRow = document.createElement('div');
                mainRow.classList.add('todo-main-row');

                const textSpan = document.createElement('span');
                textSpan.textContent = item.task;
                textSpan.classList.add('todo-text');
                if (item.completed) {
                    textSpan.classList.add('todo-completed');
                }
                textSpan.onclick = () => TodoLogic.toggleTodoComplete(index);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Remove';
                deleteBtn.classList.add('secondary');
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    TodoLogic.deleteTodo(index);
                };
                
                mainRow.appendChild(textSpan);
                mainRow.appendChild(deleteBtn);
                li.appendChild(mainRow);
                
                if (item.dueDate || item.recurrence !== 'none') {
                    const details = document.createElement('div');
                    details.classList.add('todo-details');
                    
                    let detailText = '';
                    if (item.dueDate) {
                        detailText += `Due: ${DateUtils.formatDateForDisplayShort(item.dueDate)}`;
                    }
                    if (item.recurrence && item.recurrence !== 'none') {
                        if (item.dueDate) detailText += ' | ';
                        detailText += `Repeats: ${TodoLogic.getRecurrenceLabel(item.recurrence)}`;
                    }
                    details.textContent = detailText;
                    li.appendChild(details);
                }
                todoListElement.appendChild(li);
            });
        },
        addTodo: (task, dueDate, recurrence) => {
            const list = Storage.getTodoList();
            list.push({ 
                task: task, 
                completed: false,
                dueDate: dueDate || '', 
                recurrence: recurrence || 'none'
            });
            Storage.saveTodoList(list);
            TodoLogic.renderTodoList();
        },
        toggleTodoComplete: (index) => {
            const list = Storage.getTodoList();
            if (list[index]) {
                list[index].completed = !list[index].completed;
                Storage.saveTodoList(list);
                TodoLogic.renderTodoList();
            }
        },
        deleteTodo: (index) => {
            const list = Storage.getTodoList();
            list.splice(index, 1);
            Storage.saveTodoList(list);
            TodoLogic.renderTodoList();
        },
        updateRecurringTasks: () => {
            let list = Storage.getTodoList();
            const now = DateUtils.getFormattedDate(new Date());
            let updated = false;

            list.forEach((item) => {
                if (item.completed && item.recurrence !== 'none' && item.dueDate) {
                    const taskDueDate = item.dueDate;
                    if (taskDueDate < now) {
                        let nextDate = new Date(taskDueDate);
                        
                        while (DateUtils.getFormattedDate(nextDate) < now) {
                            const originalDate = new Date(nextDate);
                            
                            switch (item.recurrence) {
                                case 'daily':
                                    nextDate.setDate(originalDate.getDate() + 1);
                                    break;
                                case 'weekly':
                                    nextDate.setDate(originalDate.getDate() + 7);
                                    break;
                                case 'biweekly':
                                    nextDate.setDate(originalDate.getDate() + 14);
                                    break;
                                case 'monthly':
                                    nextDate.setMonth(originalDate.getMonth() + 1);
                                    if (nextDate.getDate() !== originalDate.getDate()) {
                                        nextDate.setDate(0); 
                                    }
                                    break;
                                case 'yearly':
                                    nextDate.setFullYear(originalDate.getFullYear() + 1);
                                    break;
                            }
                            if (DateUtils.getFormattedDate(nextDate) < now) {
                                item.dueDate = DateUtils.getFormattedDate(nextDate);
                            }
                        }
                        
                        if (item.dueDate !== taskDueDate) {
                            item.completed = false;
                            item.dueDate = DateUtils.getFormattedDate(nextDate);
                            updated = true;
                        }
                    }
                }
            });

            if (updated) {
                Storage.saveTodoList(list);
            }
        }
    };
    
    // --- Workbook Logic ---
    const WorkbookLogic = {
        showStepOneView: () => {
            ViewManager.displayAppView('stepOneView');
            WorkbookLogic.renderWorkbook('stepOneQuestions', AppData.WORKBOOK_STEP1_QUESTIONS, Storage.getStepOneAnswers, 'saveStepOneBtn', 'stepOneSaveStatus');
        },
        showStepTwoView: () => {
            ViewManager.displayAppView('stepTwoView');
            WorkbookLogic.renderWorkbook('stepTwoQuestions', AppData.WORKBOOK_STEP2_QUESTIONS, Storage.getStepTwoAnswers, 'saveStepTwoBtn', 'stepTwoSaveStatus');
        },
        showStepThreeView: () => {
            ViewManager.displayAppView('stepThreeView');
            WorkbookLogic.renderWorkbook('stepThreeQuestions', AppData.WORKBOOK_STEP3_QUESTIONS, Storage.getStepThreeAnswers, 'saveStepThreeBtn', 'stepThreeSaveStatus');
        },
        showStepFourView: () => { 
            ViewManager.displayAppView('stepFourView');
            WorkbookLogic.renderWorkbook('stepFourQuestions', AppData.WORKBOOK_STEP4_QUESTIONS, Storage.getStepFourAnswers, 'saveStepFourBtn', 'stepFourSaveStatus');
        },
        toggleSection: (headerElement) => {
            const content = headerElement.nextElementSibling;
            const icon = headerElement.querySelector('.collapse-icon');
            content.classList.toggle('collapsed');
            headerElement.classList.toggle('collapsed');
        },
        renderWorkbook: (containerId, questions, getAnswersFn, saveButtonId, saveStatusId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const answers = getAnswersFn(questions); // Pass questions to getAnswersFn
            let answerIndex = 0; 
            
            let currentSectionContent = null;
            let isFirstSection = true;
            
            questions.forEach((q, index) => {
                if (q.isSection) {
                    if (currentSectionContent) {
                        container.appendChild(currentSectionContent);
                    }
                    
                    const header = document.createElement('div');
                    header.classList.add('workbook-section-header');
                    
                    if (!isFirstSection) {
                        header.classList.add('collapsed');
                    }
                    
                    const h3 = document.createElement('h3');
                    h3.textContent = q.title;
                    
                    const icon = document.createElement('span');
                    icon.classList.add('collapse-icon');
                    icon.textContent = '▼';
                    
                    header.appendChild(h3);
                    header.appendChild(icon);
                    
                    currentSectionContent = document.createElement('div');
                    currentSectionContent.classList.add('section-content');
                    if (!isFirstSection) {
                        currentSectionContent.classList.add('collapsed');
                    }
                    
                    header.onclick = () => WorkbookLogic.toggleSection(header);
                    
                    container.appendChild(header);
                    isFirstSection = false;
                    
                    return;
                }
                
                if (currentSectionContent) {
                    const div = document.createElement('div');
                    div.classList.add('workbook-question');

                    const h4 = document.createElement('h4');
                    h4.textContent = `${answerIndex + 1}. ${q}`;
                    
                    const textarea = document.createElement('textarea');
                    textarea.setAttribute('data-question-index', answerIndex);
                    textarea.value = answers[answerIndex] || ''; 
                    textarea.placeholder = 'Write your honest answer here...';

                    div.appendChild(h4);
                    div.appendChild(textarea);
                    currentSectionContent.appendChild(div);
                    
                    answerIndex++; 
                }
            });
            
            if (currentSectionContent) {
                 container.appendChild(currentSectionContent);
            }
            
            document.getElementById(saveStatusId).textContent = '';
            
            // Re-bind save listener since content is dynamically generated
            const saveBtn = document.getElementById(saveButtonId);
            if (saveBtn) {
                saveBtn.onclick = () => WorkbookLogic.collectAndSaveWorkbookAnswers(containerId, saveButtonId, saveStatusId);
            }
        },
        collectAndSaveWorkbookAnswers: (containerId, saveButtonId, saveStatusId) => {
            const textareas = document.querySelectorAll(`#${containerId} textarea`);
            
            let getAnswersFn, saveAnswersFn, questions;
            if (containerId === 'stepOneQuestions') {
                getAnswersFn = Storage.getStepOneAnswers;
                saveAnswersFn = Storage.saveStepOneAnswers;
                questions = AppData.WORKBOOK_STEP1_QUESTIONS;
            } else if (containerId === 'stepTwoQuestions') {
                getAnswersFn = Storage.getStepTwoAnswers;
                saveAnswersFn = Storage.saveStepTwoAnswers;
                questions = AppData.WORKBOOK_STEP2_QUESTIONS;
            } else if (containerId === 'stepThreeQuestions') {
                getAnswersFn = Storage.getStepThreeAnswers;
                saveAnswersFn = Storage.saveStepThreeAnswers;
                questions = AppData.WORKBOOK_STEP3_QUESTIONS;
            } else if (containerId === 'stepFourQuestions') {
                getAnswersFn = Storage.getStepFourAnswers;
                saveAnswersFn = Storage.saveStepFourAnswers;
                questions = AppData.WORKBOOK_STEP4_QUESTIONS;
            } else {
                return;
            }
            
            let answers = getAnswersFn(questions);
            
            textareas.forEach(textarea => {
                const index = parseInt(textarea.getAttribute('data-question-index'));
                if (index >= 0 && index < answers.length) {
                    answers[index] = textarea.value;
                }
            });

            saveAnswersFn(answers);
            document.getElementById(saveStatusId).textContent = 'Progress Saved!';
            
            setTimeout(() => {
                document.getElementById(saveStatusId).textContent = '';
            }, 3000);
        }
    };
    
    // --- Daily Reflection Logic ---
    const ReflectionLogic = {
        showReflectionView: () => {
            ViewManager.displayAppView('reflectionView');
            
            const dateInput = document.getElementById('reflectionDateInput');
            dateInput.max = DateUtils.getFormattedDate(new Date());
            
            // Default to today's date
            const today = DateUtils.getFormattedDate(new Date());
            if (!dateInput.value) {
                dateInput.value = today;
            }
            
            ReflectionLogic.getDailyReflection(dateInput.value);
        },

        getDailyReflection: async (dateStr) => {
            const date = new Date(dateStr);
            const dateDisplay = DateUtils.formatDateForDisplay(dateStr);
            
            const spinner = document.getElementById('reflectionSpinner');
            const quoteEl = document.getElementById('reflectionQuote');
            const readingEl = document.getElementById('reflectionReading');

            quoteEl.style.display = 'none';
            readingEl.style.display = 'none';
            
            // FIX: Handle missing API key explicitly
            if (!GEMINI_API_KEY) {
                spinner.style.display = 'none';
                quoteEl.textContent = "Error: API Key is missing. Cannot fetch Daily Reflection.";
                quoteEl.style.display = 'block';
                readingEl.textContent = "Please ensure a valid API key is configured to use this feature.";
                readingEl.style.display = 'block';
                return;
            }

            spinner.style.display = 'block';
            quoteEl.textContent = "Loading reflection..."; // Show loading text
            quoteEl.style.display = 'block';
            readingEl.textContent = "";

            const userQuery = `Find the AA Daily Reflection for ${dateDisplay}. Provide only the central quote and the main reflection/meditation text. Format the response with the quote first, followed by a double newline, then the reading.`;
            const systemPrompt = "You are a helpful assistant that uses Google Search to find and format the AA Daily Reflection for a given date. Extract the content accurately.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = GEMINI_API_URL + GEMINI_API_KEY;
            let resultText = "Could not load reflection. Check connectivity or try a different date.";

            // Implement exponential backoff for robustness
            const maxRetries = 3;
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            resultText = candidate.content.parts[0].text;
                            break; // Success, exit loop
                        }
                    } else {
                        // Throw error to trigger retry logic
                        throw new Error(`API returned status ${response.status}`);
                    }

                } catch (error) {
                    attempt++;
                    console.error(`Attempt ${attempt} failed:`, error.message);
                    if (attempt >= maxRetries) {
                        resultText = "Error fetching reflection after multiple retries. Check connectivity.";
                        break;
                    }
                    // Wait with exponential backoff (1s, 2s, 4s...)
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }


            spinner.style.display = 'none';
            
            // Parse result (expecting quote \n\n reading)
            const parts = resultText.split('\n\n');
            
            if (parts.length >= 2 && !resultText.includes("Error")) {
                quoteEl.textContent = parts[0].trim().replace(/^['"]|['"]$/g, ''); // Remove surrounding quotes if present
                readingEl.innerHTML = parts.slice(1).join('<br><br>').trim();
                quoteEl.style.display = 'block';
                readingEl.style.display = 'block';
            } else {
                // If parsing fails or an error was caught, display the error message.
                quoteEl.textContent = "Error: Content not found or bad response.";
                readingEl.textContent = "The reflection could not be loaded for this date. Try today's date.";
                quoteEl.style.display = 'block';
                readingEl.style.display = 'block';
            }
        },
        
        // NEW: Just For Today Logic
        showJFTView: () => {
            ViewManager.displayAppView('jftView');
            
            const dateInput = document.getElementById('jftDateInput');
            dateInput.max = DateUtils.getFormattedDate(new Date());
            
            const today = DateUtils.getFormattedDate(new Date());
            if (!dateInput.value) {
                dateInput.value = today;
            }
            
            ReflectionLogic.getJustForToday(dateInput.value);
        },

        getJustForToday: async (dateStr) => {
            const date = new Date(dateStr);
            const dateDisplay = DateUtils.formatDateForDisplay(dateStr);
            
            const spinner = document.getElementById('jftSpinner');
            const quoteEl = document.getElementById('jftQuote');
            const readingEl = document.getElementById('jftReading');

            quoteEl.style.display = 'none';
            readingEl.style.display = 'none';

            if (!GEMINI_API_KEY) {
                spinner.style.display = 'none';
                quoteEl.textContent = "Error: API Key is missing. Cannot fetch Just For Today.";
                quoteEl.style.display = 'block';
                readingEl.textContent = "Please ensure a valid API key is configured to use this feature.";
                readingEl.style.display = 'block';
                return;
            }

            spinner.style.display = 'block';
            quoteEl.textContent = "Loading reflection...";
            quoteEl.style.display = 'block';
            readingEl.textContent = "";

            const userQuery = `Find the NA Just For Today (JFT) reflection for ${dateDisplay}. Provide only the central quote/theme and the main reflection/meditation text. Format the response with the quote/theme first, followed by a double newline, then the reading.`;
            const systemPrompt = "You are a helpful assistant that uses Google Search to find and format the NA Just For Today reflection for a given date. Extract the content accurately.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = GEMINI_API_URL + GEMINI_API_KEY;
            let resultText = "Could not load reflection. Check connectivity or try a different date.";

            const maxRetries = 3;
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            resultText = candidate.content.parts[0].text;
                            break;
                        }
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }

                } catch (error) {
                    attempt++;
                    console.error(`Attempt ${attempt} failed:`, error.message);
                    if (attempt >= maxRetries) {
                        resultText = "Error fetching reflection after multiple retries. Check connectivity.";
                        break;
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            spinner.style.display = 'none';
            
            const parts = resultText.split('\n\n');
            
            if (parts.length >= 2 && !resultText.includes("Error")) {
                quoteEl.textContent = parts[0].trim().replace(/^['"]|['"]$/g, '');
                readingEl.innerHTML = parts.slice(1).join('<br><br>').trim();
                quoteEl.style.display = 'block';
                readingEl.style.display = 'block';
            } else {
                quoteEl.textContent = "Error: Content not found or bad response.";
                readingEl.textContent = "The reflection could not be loaded for this date. Try today's date.";
                quoteEl.style.display = 'block';
                readingEl.style.display = 'block';
            }
        }
    };
    
    // --- Initialization and Event Binding ---
    const App = {
        initializeApp: () => {
            // Set Max Dates
            const todayKey = DateUtils.getFormattedDate(new Date());
            const entryDate = document.getElementById('entryDate');
            if (entryDate) entryDate.max = todayKey;
            const soberDateInput = document.getElementById('soberDateInput');
            if (soberDateInput) soberDateInput.max = todayKey;
            const reflectionDateInput = document.getElementById('reflectionDateInput');
            if (reflectionDateInput) reflectionDateInput.max = todayKey;
            const jftDateInput = document.getElementById('jftDateInput'); // NEW
            if (jftDateInput) jftDateInput.max = todayKey; // NEW

            // Initial view setup
            ViewManager.getDailyFact();
            CardLogic.updateStatus();
            ViewManager.updateHomeSobrietyDuration();
            TodoLogic.updateRecurringTasks();
            ViewManager.displayAppView('homeScreen');

            App.bindEventListeners();
        },

        bindEventListeners: () => {
            // --- General Nav ---
            document.getElementById('goToSettingsBtn').addEventListener('click', () => ViewManager.displayAppView('settingsView'));
            document.querySelectorAll('#settingsView button.secondary, #literatureView button.secondary, #workbooksView button.secondary, #reflectionView button.secondary, #jftView button.secondary').forEach(btn => {
                if (btn.id.includes('Home')) {
                    btn.addEventListener('click', () => ViewManager.displayAppView('homeScreen'));
                }
            });
            document.getElementById('goToCardsBtn').addEventListener('click', CardLogic.drawAndDisplayCard);
            document.getElementById('nextBtn').addEventListener('click', CardLogic.drawAndDisplayCard);
            document.getElementById('resetBtn').addEventListener('click', CardLogic.resetDeck);
            document.getElementById('goToJournalBtn').addEventListener('click', () => showJournalEntryView());
            document.getElementById('goToTodoBtn').addEventListener('click', () => { ViewManager.displayAppView('todoView'); TodoLogic.renderTodoList(); });
            document.getElementById('goToLiteratureBtn').addEventListener('click', () => ViewManager.displayAppView('literatureView'));
            document.getElementById('goToWorkbooksBtn').addEventListener('click', () => ViewManager.displayAppView('workbooksView'));
            document.getElementById('goToReflectionBtn').addEventListener('click', ReflectionLogic.showReflectionView); 
            document.getElementById('goToJFTBtn').addEventListener('click', ReflectionLogic.showJFTView); // NEW

            // --- Daily Reflection Listener ---
            document.getElementById('reflectionDateInput').addEventListener('change', (e) => {
                ReflectionLogic.getDailyReflection(e.target.value);
            });
            
            // --- Just For Today Listener ---
            document.getElementById('jftDateInput').addEventListener('change', (e) => {
                ReflectionLogic.getJustForToday(e.target.value);
            });

            // --- Workbooks Nav ---
            document.getElementById('goToStep1Btn').addEventListener('click', WorkbookLogic.showStepOneView);
            document.getElementById('goToStep2Btn').addEventListener('click', WorkbookLogic.showStepTwoView);
            document.getElementById('goToStep3Btn').addEventListener('click', WorkbookLogic.showStepThreeView);
            document.getElementById('goToStep4Btn').addEventListener('click', WorkbookLogic.showStepFourView); 
            document.getElementById('stepOneWorkbooksBtn').addEventListener('click', () => ViewManager.displayAppView('workbooksView'));
            document.getElementById('stepTwoWorkbooksBtn').addEventListener('click', () => ViewManager.displayAppView('workbooksView'));
            document.getElementById('stepThreeWorkbooksBtn').addEventListener('click', () => ViewManager.displayAppView('workbooksView'));
            document.getElementById('stepFourWorkbooksBtn').addEventListener('click', () => ViewManager.displayAppView('workbooksView'));
            
            // Workbook Save Buttons are bound dynamically in renderWorkbook
            
            // --- Journal Listeners ---
            document.getElementById('entryHomeBtn').addEventListener('click', () => ViewManager.displayAppView('homeScreen'));
            document.getElementById('openListHomeBtn').addEventListener('click', () => ViewManager.displayAppView('homeScreen'));
            document.getElementById('managePromptsBtn').addEventListener('click', showPromptManagerView);
            document.getElementById('backToEntryBtn').addEventListener('click', () => showJournalEntryView(JournalEventHandlers.getCurrentJournalKey())); // Using imported handler to get state
            
            document.getElementById('addCustomPromptBtn').addEventListener('click', JournalEventHandlers.handlePromptAdd);

            document.getElementById('promptSelect').addEventListener('change', JournalEventHandlers.handlePromptSelect);

            document.getElementById('saveJournalBtn').addEventListener('click', JournalEventHandlers.handleSave);
            
            document.getElementById('entryDate').addEventListener('change', JournalEventHandlers.handleDateChange);
            document.getElementById('viewAllEntriesBtn').addEventListener('click', showJournalListView);
            document.getElementById('newEntryBtn').addEventListener('click', () => showJournalEntryView());

            // --- Settings Listeners ---
            document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                const dateStr = document.getElementById('soberDateInput').value;
                if (dateStr && new Date(dateStr) <= new Date()) {
                    Storage.saveSoberDate(dateStr);
                    ViewManager.updateHomeSobrietyDuration();
                    alert('Sober Date Saved!');
                } else {
                    alert('Please enter a valid Sober Date in the past.');
                }
            });

            // --- To Do List Listeners ---
            document.getElementById('addTodoBtn').addEventListener('click', () => {
                const input = document.getElementById('todoInput');
                const dateInput = document.getElementById('todoDateInput');
                const recurrenceSelect = document.getElementById('todoRecurrenceSelect');
                
                const task = input.value.trim();
                const dueDate = dateInput.value;
                const recurrence = recurrenceSelect.value;
                
                if (task) {
                    TodoLogic.addTodo(task, dueDate, recurrence);
                    input.value = '';
                    dateInput.value = '';
                    recurrenceSelect.value = 'none';
                } else {
                    alert('Please enter a task description.');
                }
            });
            document.getElementById('todoHomeBtn').addEventListener('click', () => ViewManager.displayAppView('homeScreen'));
        }
    };

    App.initializeApp();

    // Register Service Worker
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(function(reg) {
          console.log('Service Worker Registered');
        })
        .catch(function(err) {
          console.log('Service Worker Registration Failed:', err);
        });
    }
    // --- END: MODULAR JAVASCRIPT REFACTOR ---
  </script>
</body>
</html>
